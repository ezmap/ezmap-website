document.addEventListener("alpine:init",()=>{Alpine.data("mapEditor",a=>({addingPin:!1,addingPinByAddress:!1,addingHotSpot:!1,apikey:a.apikey||"",codeCopied:!1,currentTheme:a.currentTheme||{id:"0"},directionsDisplays:[],doubleClickZoom:a.doubleClickZoom??!0,embeddable:a.embeddable??!1,height:a.height??420,heatmap:null,heatMapData:[],heatmapLayer:a.heatmapLayer||{dissipating:!1,opacity:.6,radius:2},geocoder:{},infoDescription:"",infoEmail:"",infoTelephone:"",infoTitle:"",infoWebsite:"",infoTarget:!1,lat:a.lat??56.4778058625534,lng:a.lng??-2.86748333610688,map:{},mapcontainer:a.mapcontainer||"ez-map",mapLoaded:!1,mapTypeControlDropdown:a.mapTypeControlDropdown||[],mapTypes:a.mapTypes||[],mapTypeId:{},markers:[],joiningMarkers:!1,joinStart:null,joinStop:null,responsive:a.responsive??!0,show:!0,width:a.width??560,themeApplied:a.themeApplied??!1,mapOptions:a.mapOptions||{},mapOpacity:1,mapBackground:"none",newIconName:"",newIconUrl:"",geocodeAddressText:"",hotSpotTitle:"",hotSpotWeight:1,pendingHotSpotEvent:null,iconChangeMarkerIndex:null,savedMarkers:a.savedMarkers||[],savedHeatmap:a.savedHeatmap||[],savedHeatmapLayer:a.savedHeatmapLayer||null,mapId:a.mapId||null,storeUrl:a.storeUrl||"",imageUrl:a.imageUrl||"",kmlUrl:a.kmlUrl||"",kmzUrl:a.kmzUrl||"",addIconUrl:a.addIconUrl||"",deleteIconUrl:a.deleteIconUrl||"",csrfToken:a.csrfToken||"",_resizeTimer:null,_centerTimer:null,_zoomTimer:null,get hasDirections(){return this.directionsDisplays.length>0},get styleObject(){return this.responsive?{height:this.height+"px",width:"100%"}:{height:this.height+"px",width:this.width+"px"}},get markersToString(){const e=[];for(let t=0;t<this.markers.length;t++){const i=this.markers[t];e.push({title:i.title,icon:i.icon,lat:i.position.lat(),lng:i.position.lng(),infoWindow:{content:i.infoWindow.content||""}})}return JSON.stringify(e)},get heatMapToString(){return JSON.stringify(this.heatMapData)},get mapTypeControlStyle(){return this.mapOptions.mapTypeControlOptions?this.mapOptions.mapTypeControlOptions.style:0},set mapTypeControlStyle(e){this.mapOptions.mapTypeControlOptions||(this.mapOptions.mapTypeControlOptions={}),this.mapOptions.mapTypeControlOptions.style=parseInt(e),this.optionschange()},get selectedMapTypeId(){return this.mapTypeId.mapTypeId||"roadmap"},set selectedMapTypeId(e){this.mapTypeId=this.mapTypes.find(t=>t.mapTypeId===e)||this.mapTypes[0],this.optionschange()},get generatedCode(){const t={...{center:{lat:this.lat,lng:this.lng},clickableIcons:this.mapOptions.clickableIcons,disableDoubleClickZoom:!this.doubleClickZoom,draggable:this.mapOptions.draggable,fullscreenControl:this.mapOptions.fullscreenControl,keyboardShortcuts:this.mapOptions.keyboardShortcuts,mapTypeControl:this.mapOptions.mapTypeControl,mapTypeControlOptions:{style:this.mapOptions.mapTypeControlOptions?this.mapOptions.mapTypeControlOptions.style:0},mapTypeId:this.mapTypeId.mapTypeId||"roadmap",rotateControl:!0,scaleControl:this.mapOptions.scaleControl,scrollwheel:this.mapOptions.scrollwheel,streetViewControl:this.mapOptions.streetViewControl,styles:this.mapOptions.styles||!1,zoom:this.mapOptions.zoom,zoomControl:this.mapOptions.zoomControl}};t.styles||delete t.styles;const i=JSON.stringify(t),o=this.heatMapData.length?"&libraries=visualization":"";let s=`<!-- Google map code from EZ Map - https://ezmap.co -->
`;return s+=`<script src='https://maps.googleapis.com/maps/api/js?key=${this.apikey}${o}'><\/script>
`,s+=`<script>
`,s+=`  function init() {
`,s+=`    var mapOptions = ${i};
`,s+=`    var mapElement = document.getElementById('${this.mapcontainer}');
`,s+=`    var map = new google.maps.Map(mapElement, mapOptions);
`,s+=`    ${this.markersLoop()}${this.heatmapLoop()}
`,s+=`    ${this.responsiveOutput()}
`,s+=`  }
`,s+=`window.addEventListener('load', init);
`,s+=`<\/script>
`,s+=this.mapStyling()+`
`,s+=`<div id='${this.mapcontainer}'></div>
`,s+="<!-- End of EZ Map code - https://ezmap.co -->",s},get generatedEmbedCode(){if(!this.mapId)return this.generatedCode;let e=`<!-- Google map code from EZ Map - https://ezmap.co -->
`;return e+=`<script src="//ezmap.co/map/${this.mapId}" id="ez-map-embed-script-${this.mapId}"><\/script>
`,e+="<!-- End of EZ Map code - https://ezmap.co -->",e},get displayedCode(){return this.embeddable&&this.mapId?this.generatedEmbedCode:this.generatedCode},init(){const e=this.mapOptions.mapTypeId||"roadmap";this.mapTypeId=this.mapTypes.find(t=>t.mapTypeId===e)||this.mapTypes[0]||{mapTypeId:"roadmap"},typeof google<"u"&&google.maps?this.initMap():window._mapEditorInitCallback=()=>this.initMap(),window.addEventListener("theme-selected",t=>{const{id:i,json:o}=t.detail;this.currentTheme={id:String(i),json:o},this.mapOptions.styles=o,this.themeApplied=!0,this.optionschange()}),this.$el.addEventListener("click",t=>{t.target.classList.contains("markericon")&&this.setMarkerIcon(t)})},showCenter(){this.mapOpacity=this.mapOpacity===1?.5:1;const t=document.documentElement.classList.contains("dark")?"/images/crosshairs-white.svg":"/images/crosshairs.svg";this.mapBackground=this.mapOpacity===.5?`transparent url(${t}) center center no-repeat`:"none";const i=document.getElementById("map");i&&i.firstChild&&(i.firstChild.style.opacity=this.mapOpacity),i&&(i.style.background=this.mapBackground)},clearDirections(){for(let e=0;e<this.directionsDisplays.length;e++)this.directionsDisplays[e].setMap(null);this.directionsDisplays=[]},beginJoin(e){this.joiningMarkers=!0,this.joinStart=this.markers[e]},endJoin(e){this.joiningMarkers=!1,this.joinStop=this.markers[e],this.calcRoute(this.joinStart,this.joinStop)},calcRoute(e,t){const i=new google.maps.DirectionsRenderer({draggable:!0,suppressMarkers:!0,preserveViewport:!0}),o=new google.maps.DirectionsService,s={origin:e.position,destination:t.position,travelMode:google.maps.TravelMode.DRIVING},n=this;o.route(s,(r,p)=>{p===google.maps.DirectionsStatus.OK?(i.setDirections(r),i.setMap(n.map),n.directionsDisplays.push(i)):alert("Route failed: "+p)})},clearTheme(){this.mapOptions.styles=[],this.currentTheme={id:"0"},this.themeApplied=!1,this.optionschange()},markersLoop(){let e="";for(let t=0;t<this.markers.length;t++){const i=this.markers[t];e+="var marker"+t+' = new google.maps.Marker({title: "'+i.title+'", icon: "'+i.icon+'", position: new google.maps.LatLng('+i.position.lat()+", "+i.position.lng()+`), map: map});
`,i.infoWindow.content&&(e+="var infowindow"+t+" = new google.maps.InfoWindow({content: "+JSON.stringify(i.infoWindow.content)+`,map: map});
`,e+="marker"+t+".addListener('click', function () { infowindow"+t+".open(map, marker"+t+") ;});infowindow"+t+`.close();
`)}return e},heatmapLoop(){if(this.heatMapData.length===0)return"";let e="";e+="var heatmap = new google.maps.visualization.HeatmapLayer({data: [";for(let t=0;t<this.heatMapData.length;t++)e+="{ location: new google.maps.LatLng("+this.heatMapData[t].weightedLocation.location.lat+","+this.heatMapData[t].weightedLocation.location.lng+"), weight: "+this.heatMapData[t].weightedLocation.weight+"},";return e+="]});",e+="heatmap.setOptions("+JSON.stringify(this.heatmapLayer)+");",e+="heatmap.setMap(map);",e},responsiveOutput(){return this.responsive?'window.addEventListener("resize", function() { var center = map.getCenter(); google.maps.event.trigger(map, "resize"); map.setCenter(center); });':""},mapStyling(){let e=`<style>
  `;return e+="#"+this.mapcontainer+" { ",e+="min-height:150px; min-width:150px; height: "+this.styleObject.height+"; width: "+this.styleObject.width+";",e+=" }",this.markers.length&&(e+=`
  #`+this.mapcontainer+" .infoTitle { /*marker window title styles*/ }",e+=`
  #`+this.mapcontainer+" .infoWebsite { /*marker window website styles*/ }",e+=`
  #`+this.mapcontainer+" .infoEmail { /*marker window email address styles*/ }",e+=`
  #`+this.mapcontainer+" .infoTelephone { /*marker window telephone styles*/ }",e+=`
  #`+this.mapcontainer+" .infoDescription { /*marker window description styles*/ }"),e+=`
</style>`,e},debouncedMapResized(){clearTimeout(this._resizeTimer),this._resizeTimer=setTimeout(()=>this.mapresized(),500)},mapresized(){if(!this.mapLoaded){this.initMap();return}google.maps.event.trigger(this.map,"resize")},async copied(){const e=this.displayedCode;try{await navigator.clipboard.writeText(e)}catch{const i=document.createElement("textarea");i.textContent=e,document.body.append(i),i.select(),document.execCommand("copy"),i.remove()}this.codeCopied=!0,setTimeout(()=>{this.codeCopied=!1},3e3)},zoomchanged(){this.map.setZoom(parseInt(this.mapOptions.zoom))},debouncedCenterChanged(){clearTimeout(this._centerTimer),this._centerTimer=setTimeout(()=>this.centerchanged(),500)},centerchanged(){this.mapLoaded&&(this.map.setCenter(new google.maps.LatLng(parseFloat(this.lat),parseFloat(this.lng))),this.optionschange())},mapmoved(){this.mapOptions.center=this.map.getCenter(),this.lat=this.mapOptions.center.lat(),this.lng=this.mapOptions.center.lng()},mapzoomed(){this.mapOptions.zoom=this.map.getZoom()},optionschange(){this.mapLoaded&&(this.mapOptions.disableDoubleClickZoom=!this.doubleClickZoom,this.mapOptions.mapTypeId=this.mapTypeId.mapTypeId||"roadmap",this.map.setOptions(this.mapOptions))},heatmapChange(){if(!this.mapLoaded)return;this.heatmap===null&&(this.heatmap=new google.maps.visualization.HeatmapLayer([]));const e=[];for(let t=0;t<this.heatMapData.length;t++){const i=this.heatMapData[t].weightedLocation.location,o=this.heatMapData[t].weightedLocation.weight;e.push({location:new google.maps.LatLng(i.lat,i.lng),weight:o})}this.heatmap.setData(e),this.heatmap.setOptions(this.heatmapLayer)},maptypeidchanged(){this.mapOptions.mapTypeId=this.map.getMapTypeId(),this.mapTypeId=this.mapTypes.find(e=>e.mapTypeId===this.mapOptions.mapTypeId)||this.mapTypes[0]},buildInfoWindowContent(){let e="";if(this.infoTitle&&(e+='<h3 class="infoTitle">'+this.escapeHtml(this.infoTitle)+"</h3>"),e+="<p>",this.infoWebsite){const t=this.infoTarget?' target="_blank"':"";e+='<span class="infoWebsite"><a'+t+' href="'+this.escapeHtml(this.infoWebsite)+'">'+this.escapeHtml(this.infoWebsite)+"</a><br></span>"}return this.infoEmail&&(e+='<span class="infoEmail"><a href="mailto:'+this.escapeHtml(this.infoEmail)+'">'+this.escapeHtml(this.infoEmail)+"</a><br></span>"),this.infoTelephone&&(e+='<span class="infoTelephone">'+this.escapeHtml(this.infoTelephone)+"</span>"),e+="</p>",this.infoDescription&&(e+='<p class="infoDescription">'+this.escapeHtml(this.infoDescription).replace(/\n/g,"<br>")+"</p>"),e},escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML},addInfoBox(){const e=this.markers[this.markers.length-1],t=this.buildInfoWindowContent(),i=new google.maps.InfoWindow({content:t});e.infoWindow=i,e.title=this.infoTitle!==""?this.infoTitle:e.title,e.setTitle(e.title);const o=this.map;e.addListener("click",()=>{i.open(o,e)}),Flux.modal("marker-info").close(),this.centerchanged()},dismissInfoBox(){Flux.modal("marker-info").close()},removeMarker(e){this.markers[e].setMap(null),this.markers.splice(e,1)},removeAllMarkers(){if(window.confirm("Are you sure you want to delete the "+this.markers.length+" markers from this map?")){for(let e=0;e<this.markers.length;e++)this.markers[e].setMap(null);this.markers=[]}},removeAllHotSpots(){window.confirm("Are you sure you want to delete the "+this.heatMapData.length+" hotspots from this map?")&&(this.heatMapData=[]),this.heatmapChange()},centerOnMarker(e){this.map.setCenter(this.markers[e].position)},centerOnHotSpot(e){const t=this.heatMapData[e].weightedLocation.location;this.map.setCenter(new google.maps.LatLng(t.lat,t.lng))},changeMarkerIcon(e){this.iconChangeMarkerIndex=e,document.querySelectorAll(".markericon").forEach(t=>{t.dataset.forMarker=e}),Flux.modal("marker-pin").show()},setMarkerIcon(e){const t=e.target;if(!t.classList.contains("markericon"))return;const i=this.iconChangeMarkerIndex!==null?this.iconChangeMarkerIndex:parseInt(t.dataset.forMarker);this.markers[i]&&(this.markers[i].setIcon(t.getAttribute("src")),this.markers[i].icon=t.getAttribute("src")),Flux.modal("marker-pin").close()},showAddressModal(){this.addingPinByAddress=!0,this.geocodeAddressText="",Flux.modal("geocode-address").show(),this.$nextTick(()=>{const e=document.getElementById("geocodeAddress");e&&e.focus()})},geocodeAddress(){const e=this.geocodeAddressText;e&&this.geocoder.geocode({address:e},(t,i)=>{i===google.maps.GeocoderStatus.OK?(Flux.modal("geocode-address").close(),this.placeMarker({latLng:t[0].geometry.location}),this.geocodeAddressText=""):alert("Geocode was not successful for the following reason: "+i)})},placeMarker(e){if(this.addingPin||this.addingPinByAddress){const t=new google.maps.Marker({icon:"https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi.png",position:e.latLng,map:this.map,draggable:!0,title:"No Title",infoWindow:{content:""},startsRoutes:[],endsRoutes:[]});this.markers.push(t),this.infoTitle="",this.infoEmail="",this.infoWebsite="",this.infoTelephone="",this.infoDescription="",this.infoTarget=!1,Flux.modal("marker-info").show(),this.addingPin=this.addingPinByAddress=!1}},placeHotSpot(e){this.addingHotSpot&&(this.pendingHotSpotEvent=e,this.hotSpotTitle=e.latLng.toString(),this.hotSpotWeight=1,Flux.modal("hotspot-prompt").show())},confirmHotSpot(){this.pendingHotSpotEvent&&(this.heatMapData.push({title:this.hotSpotTitle||this.pendingHotSpotEvent.latLng.toString(),weightedLocation:{location:this.pendingHotSpotEvent.latLng.toJSON(),weight:Number(this.hotSpotWeight)||1}}),this.pendingHotSpotEvent=null),this.addingHotSpot=!1,this.heatmapChange(),Flux.modal("hotspot-prompt").close()},removeHotSpot(e){this.heatMapData.splice(e,1),this.heatmapChange()},duplicateMap(){const e=document.getElementById("mainForm"),t=e.querySelector('input[name="title"]');t&&(t.value=t.value+" - copy");const i=e.querySelector('input[name="_method"]');i&&(i.value="POST"),e.action=this.storeUrl,e.submit()},openImage(){this.imageUrl&&window.open(this.imageUrl,"_blank")},addSavedInfoWindow(e,t){const i=this.map;e.addListener("click",()=>{t.open(i,e)})},async addNewIcon(){if(!(!this.newIconName||!this.newIconUrl))try{const e=await fetch(this.addIconUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":this.csrfToken,Accept:"application/json"},body:JSON.stringify({newIconName:this.newIconName,newIconURL:this.newIconUrl})});if(e.ok){const t=await e.json();window.location.reload()}}catch(e){console.error("Failed to add icon:",e)}},initMap(){if(this.mapOptions.center=new google.maps.LatLng(this.lat,this.lng),this.map=new google.maps.Map(document.getElementById("map"),this.mapOptions),this.geocoder=new google.maps.Geocoder,this.mapLoaded=!0,this.mapmoved(),this.savedMarkers&&this.savedMarkers.length)for(let e=0;e<this.savedMarkers.length;e++){const t=this.savedMarkers[e],i=new google.maps.Marker({icon:t.icon,position:new google.maps.LatLng(t.lat,t.lng),map:this.map,draggable:!0,title:t.title,infoWindow:t.infoWindow});if(t.infoWindow&&t.infoWindow.content){const o=new google.maps.InfoWindow(t.infoWindow);this.addSavedInfoWindow(i,o)}this.markers.push(i)}this.savedHeatmap&&this.savedHeatmap.length&&(this.heatMapData=this.savedHeatmap),this.savedHeatmapLayer&&(this.heatmapLayer=this.savedHeatmapLayer),this.heatmap=new google.maps.visualization.HeatmapLayer([]),this.heatmapChange(),this.heatmap.setOptions(this.heatmapLayer),this.heatmap.setMap(this.map),google.maps.event.addListener(this.map,"resize",()=>this.centerchanged()),google.maps.event.addListener(this.map,"center_changed",()=>this.mapmoved()),google.maps.event.addListener(this.map,"zoom_changed",()=>this.mapzoomed()),google.maps.event.addListener(this.map,"maptypeid_changed",()=>this.maptypeidchanged()),google.maps.event.addListener(this.map,"click",e=>this.placeMarker(e)),google.maps.event.addListener(this.map,"click",e=>this.placeHotSpot(e))}}))});
